# zkAliPay Smart Contracts

This directory contains the Solidity smart contracts for zkAliPay, a peer-to-peer USDC/CNY exchange platform using zkPDF proofs for payment verification.

## ğŸ“ Directory Structure

```
contracts/
â”œâ”€â”€ src/                           # Smart contract source files
â”‚   â”œâ”€â”€ ZkAliPayEscrow.sol        # Main escrow contract
â”‚   â”œâ”€â”€ OpenVmHalo2Verifier.sol   # OpenVM proof verifier
â”‚   â”œâ”€â”€ Halo2Verifier.sol         # Halo2 verifier implementation
â”‚   â”œâ”€â”€ IOpenVmHalo2Verifier.sol  # Verifier interface
â”‚   â””â”€â”€ mocks/                    # Mock contracts for testing
â”œâ”€â”€ script/                        # Deployment scripts
â”‚   â””â”€â”€ Deploy.s.sol              # Universal deployment script
â”œâ”€â”€ test/                          # Contract tests
â”œâ”€â”€ lib/                           # Dependencies (Forge, OpenZeppelin, etc.)
â”œâ”€â”€ out/                           # Compiled contracts
â”œâ”€â”€ deploy.sh                      # Deployment helper script
â”œâ”€â”€ foundry.toml                   # Foundry configuration
â””â”€â”€ README.md                      # This file
```

## ğŸš€ Quick Start

### Prerequisites

- [Foundry](https://book.getfoundry.sh/getting-started/installation) installed
- [jq](https://stedolan.github.io/jq/) for JSON parsing: `brew install jq`
- Alchemy API key for RPC access
- Etherscan API key for contract verification (optional)

### Installation

```bash
cd contracts
forge install
```

### Build

```bash
forge build
```

### Test

```bash
forge test
```

## ğŸ“¦ Deployment

### Method 1: Using deploy.sh (Recommended)

The `deploy.sh` script reads configuration from `../deployment.config.json` and handles all environment setup automatically.

```bash
# Deploy to Base Sepolia testnet
./deploy.sh base-sepolia

# Deploy to Ethereum Sepolia testnet
./deploy.sh sepolia

# Deploy to Base mainnet (production)
./deploy.sh base-mainnet
```

**Steps:**
1. Update `../deployment.config.json` with your network configuration
2. Run `./deploy.sh <network>`
3. Copy deployed contract addresses from output
4. Update `deployment.config.json` with new addresses
5. Run `node ../scripts/generate-env.js <network>` to update env files

### Method 2: Manual Deployment

```bash
# Set environment variables
export DEPLOYER_PRIVATE_KEY="your_private_key"
export RPC_URL="your_rpc_url"
export VERIFIER_ADDRESS="0x0000000000000000000000000000000000000000"  # 0x0 = deploy new
export PUBLIC_KEY_DER_HASH="0x..."
export APP_EXE_COMMIT="0x..."
export APP_VM_COMMIT="0x..."
export DEPLOY_MOCK_USDC="true"  # true for testnet, false for mainnet

# Run deployment
forge script script/Deploy.s.sol:Deploy \
    --rpc-url $RPC_URL \
    --private-key $DEPLOYER_PRIVATE_KEY \
    --broadcast \
    --verify \
    --etherscan-api-key $ETHERSCAN_API_KEY
```

## ğŸ”§ Configuration

All deployment configuration is centralized in `../deployment.config.json`:

```json
{
  "networks": {
    "base-sepolia": {
      "chainId": 84532,
      "rpcUrl": "https://base-sepolia.g.alchemy.com/v2/YOUR_KEY",
      "blockExplorer": "https://sepolia.basescan.org",
      "contracts": {
        "escrow": "TO_BE_DEPLOYED",
        "mockUsdc": "TO_BE_DEPLOYED"
      },
      "relayWallet": {
        "address": "TO_BE_SET",
        "privateKey": "TO_BE_SET"
      }
    }
  }
}
```

## ğŸ“ Contract Addresses

### Base Sepolia (Current)
- **ZkAliPayEscrow**: `0xe03C7b74A7c4338E397c65d8B60b18FAF56E3546`
- **MockUSDC**: `0xd4B280FFB336e2061cB39347Bd599cB88FF1617A`
- **OpenVmHalo2Verifier**: `0xE1859d7071eD3CE7F1AB592c76c3A6D342140A87`

## ğŸ” Security Notes

âš ï¸ **IMPORTANT**: Never commit private keys or sensitive data to git!

- All sensitive configuration is in `deployment.config.json` (gitignored)
- Test wallets are for testnet only
- Use hardware wallets or secure key management for production
- Always verify contracts on block explorer after deployment

## ğŸ§ª Testing

```bash
# Run all tests
forge test

# Run specific test
forge test --match-test testFillOrder

# Run with gas reporting
forge test --gas-report

# Run with verbosity
forge test -vvv
```

## ğŸ“š Key Contracts

### ZkAliPayEscrow.sol
Main escrow contract handling:
- Order creation and management
- Trade execution and settlement
- zkPDF proof verification
- Multi-token support (USDC, USDT, ETH, BTC, SOL, etc.)

### OpenVmHalo2Verifier.sol
Verifies zkPDF proofs generated by Axiom API using OpenVM.

## ğŸŒ Supported Networks

- **Base Sepolia** - Current testnet (lower gas costs)
- **Base Mainnet** - Production deployment (to be deployed)

## ğŸ“– Additional Resources

- [Foundry Book](https://book.getfoundry.sh/)
- [OpenVM Documentation](https://docs.openvm.dev/)
- [Base Documentation](https://docs.base.org/)
- [Axiom Documentation](https://docs.axiom.xyz/)

## ğŸ¤ Contributing

When adding new contracts or modifying existing ones:
1. Write comprehensive tests
2. Document all functions
3. Run `forge fmt` before committing
4. Update this README if needed

---

**Last Updated**: November 12, 2025  
**Version**: 3.0.0 (zkAliPay Rebrand + Configurable Parameters)
